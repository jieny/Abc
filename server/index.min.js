(function(){let e=window;e.rememberPassword=!1;let t=Uint8Array;e.devices=[];let r=e.get=(e=>document.getElementById(e)),n=e.create=((e,t)=>{e=e||"div";let r=document.createElement(e);return t&&(r.style.display="inline-block"),r});e.getType=function(e,t){let r=Object.prototype.toString.call(e).toLowerCase().split(" ")[1];return r=r.substring(0,r.length-1),"array"==r?"a":"uint8array"==r?"u8a":"string"==r?r:"number"==r?t?e<0?r:e>=0&&e<255?"u8":e>=255&&e<65535?"u16":e>=65535&&e<4294967295?"u32":"u64":r:"bigint"==r?"b":"object"==r?t?e.constructor.name?e.constructor.name:"uo":"o":"arraybuffer"==r?"ab":"function"==r?"f":"date"==r?"d":"dataview"==r?"dv":r},t.prototype.toHex=function(){let e="";for(let t of this){let r;t?(r=t.toString(16),1==r.length&&(r="0"+r)):r="00",e+=r}return e},String.prototype.toU8a=function(){if(this.length%2)return;let e=this,r=new t(e.length/2),n=0;for(let t=0;t<e.length;t+=2)r[n++]=parseInt(e.substring(t,t+2),16);return r};let s=e.decrypt=((e,t,r,n)=>{if(!e)return"";t=CryptoJS.enc.Hex.parse(t),r=CryptoJS.enc.Hex.parse(r),e=CryptoJS.enc.Hex.parse(e),e=CryptoJS.enc.Base64.stringify(e);let s=CryptoJS.AES.decrypt(e,t,{iv:r,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}),o=s.toString(CryptoJS.enc.Hex);return n?o.toU8a():o});e.encrypt=((e,t,r,n)=>{if(!e)return"";t=CryptoJS.enc.Hex.parse(t),r=CryptoJS.enc.Hex.parse(r);let s=CryptoJS.enc.Hex.parse(e),o=CryptoJS.AES.encrypt(s,t,{iv:r,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}),a=o.ciphertext.toString();return n?a.toU8a():a}),(t=>{let r=localStorage,n=JSON;class s{constructor(e){if(this.key=e,this.arr=0,this.exists=!1,r[e]&&r[e].length)try{this.arr=n.parse(r[e]),this.exists=!0}catch(e){this.arr=[]}else this.arr=[]}update(){r[this.key]=n.stringify(this.arr)}find(e){return this.arr.find(e)}size(){return this.arr.length}filter(e){return this.arr.filter(e)}findIndex(e){return this.arr.findIndex(e)}push(e,t){this.arr.push(e),t||this.update()}splice(e,t,r){this.arr.splice(e,t||1),r||this.update()}spliceIfExists(e,t){let r=this.findIndex(e);r>=0&&this.splice(r,t)}pushIfNotExists(e,t,r){this.set(e,t,r)}get(e,t){let r=this,n=r.findIndex(e);if(n>=0)return t?{index:n,data:r.arr[n]}:r.arr[n]}set(e,t,r){let n=this,s=n.findIndex(e);s>=0?n.arr[s]=t:n.arr.push(t),r||n.update()}concat(e,t){let r=this;r.arr=e instanceof s?r.arr.concat(e.arr):r.arr.concat(e),t||r.update}forEach(e){for(let t of this.arr)e(t)}}e.LSAsArray=s})();let o=new LSAsArray("users");e.setEventEmitter=(e=>{e.on=((t,r,n,s,o)=>{if(e["@"+t]||(e["@"+t]=[]),!n)return void e["@"+t].push({id:n,fn:r,obj:s,disposable:o});let a=e["@"+t].find(e=>e.id==n);a||e["@"+t].push({id:n,fn:r,obj:s,disposable:o})}),e.emit=((t,r)=>{let n=e["@"+t];if(!n)return;for(let e=0;e<n.length;e++)n[e].obj?n[e].run=!n[e].fn.apply(n[e].obj,[r]):n[e].run=!n[e].fn(r);let s=n.length;for(let e=0;e<s;e++)n[e]&&n[e].run&&n[e].disposable&&(n.splice(e,1),e--)})});let a=e.showMsg=((e,t)=>{let n=r("divMsg");if(n.t)try{clearTimeout(n.t)}catch(e){}n.className="divMsg divMsgShow",n.innerHTML=e,n.t=setTimeout(()=>{n.className="divMsg"},t||3e3)});(t=>{setEventEmitter(e),e.on("connected",t=>{e.connected=!0,a("已建立连接")}),e.on("unknownData",e=>{a("接收到了未知消息")}),e.on("disconnected",t=>{e.connected=!1,a("已断开连接")}),e.on("connectionError",t=>{e.connected=!1,a("连接发生错误")}),e.on("unknownCommand",function(e){a("接收到了未知命令"+e.toString())}),e.on("newDevice",function(t){let n=e.devices.find(e=>e.id==t[7]);n?n.updateInfo(t):(n=new Device(t),e.devices.push(n),r("devices").appendChild(n.container))});let n=r("btnRemPwd"),s=r("remPwdDot");n.onclick=(t=>{e.rememberPassword?(e.rememberPassword=!1,s.className+="remPwdDot",e.readPwdFromCache&&a("是否清除保存的密码?<a class='smallButton' onclick='removeUserInfo()'>是</a>",1e4)):(e.rememberPassword=!0,s.className+=" remPwdDotSelected")})})(),e.removeUserInfo=(e=>{delete localStorage.users,a("密码已清除"),r("remPwdDot").className="remPwdDot"}),e.generateHash=(t=>{let r=(new Date).getTime().toString();return{t:r,hash:getHash(e.userName+e.password+r)}});let i=t=>e.devices.find(e=>e.id==t),c=t=>{t=t.data,"ab"!=getType(t)&&e.emit("unknownData");let r=decodeArrayBuffer(t);if(r&&r.length){let t=r[0],n=getType(t,!0);if("b"===n){let e=BigInt(255);t&=e,t=Number(t)}else if("u8"!=n)return;switch(t){case 12:sendArrayBuffer([192]);break;case 250:e.emit("newDevice",r);break;case 174:{let e=i(r[1]);e&&e.otaProgress(r[2]);break}case 182:{let e=i(r[2]);e&&e.commandResponse(r[3]);break}case 251:{r[1]="u8a"==getType(r[1])?r[1].toHex():r[1];let t=i(r[1]);if(t)if(5==r.length){let n=s(r[3].toHex(),e.password,e.password.substring(0,32),!0);n&&n.length&&t.showMsg(decodeArrayBuffer(n.buffer))}else t.showMsg("u8a"==getType(r[3])?decodeArrayBuffer(r[3].buffer):r[3]);break}default:e.emit("unknownCommand",t)}}};e.resetWebsocket=function(){e.webSocket=new WebSocket("ws://"+e.location.host),webSocket.binaryType="arraybuffer",webSocket.onopen=function(){e.emit("connected")},webSocket.onclose=function(){e.emit("disconnected"),setTimeout(()=>{e.resetWebsocket()},1e3)},webSocket.onmessage=function(e){c(e)},webSocket.onerror=function(t){e.emit("connectionError")}},e.resetWebsocket(),e.sendArrayBuffer=(e=>{webSocket.send(createArrayBuffer(e))});let d=(t,n,s)=>{e.password=n=s?n:getHash(n),r("divLogin").className+=" divLoginHide",r("devices").className+=" devicesShow",e.rememberPassword&&t.length&&n.length&&(o.set(e=>e.userName==t,{userName:t,password:n}),a("密码已存储")),e.userName=t=getHash(t),e.id=getHash(t+n+"admin");let i=(new Date).getTime(),c=new Uint8Array(getHash(t+n+i.toString(),!0)),d=BigInt("0xC0000000000000AF");sendArrayBuffer([d,e.id,e.userName,i,c])};o.size()&&(1==o.size()?e.on("connected",t=>{e.readPwdFromCache=!0,e.rememberPassword=!0,r("remPwdDot").className+=" remPwdDotSelected",setTimeout(()=>{let t=o.get(e=>!0);e.rememberPassword&&d(t.userName,t.password,!0)},1e3)}):o.forEach(t=>{let s=n("a");s.className="button",s.innerText=t.userName,s.onclick=function(){e.readPwdFromCache=!0,d(t.userName,t.password,!0)},r("btnContainer").appendChild(s)})),r("login").onclick=function(){d(r("userName").value,r("password").value,0)},(e=>{let t=document.getElementsByTagName("a");for(let e of t)e.className.indexOf("button")>=0&&!e.href&&(e.href="javascript:void(0);")})()})();