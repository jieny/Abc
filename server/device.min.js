(function(){let e=window,t=(e,t,i,n,a)=>{let r=create("a");return r.className=a||"button",r.innerText=e,r.onclick=t,r.ondblclick=i,n&&(r.id=n),r};class i{constructor(e,t,i,n,a,r,s){this.boardID=e,this.parent=s,this.providerID=t,null!==r&&(this.customID=r,this.hasCustomID=!0),this.name=i,this.mask=n,this.isAdmin=a,this.arguments=[],this.showToUser=!1,this.buildContainer()}buildContainer(){let e=create(),i=null,n=getHash(this.boardID+this.providerID+this.name);e.id=n+"_container";let a=this.mask,r=7&a;this.lengthOfAArguments=r;let s=128&a,l=64&a,o=32&a,h=8&a;this.encrypt=!!h,s||l||o?this.isAdmin?s?i=t(this.name,e=>{this.execute()}):l&&(i=t(this.name,0,e=>{this.execute()})):e.style.display="none":(e.style.display="inline-block",i=t(this.name,e=>{this.execute()}),this.showToUser=!0);for(let t=0;t<r;++t){let i=create("input");i.type="text",i.className="LoginInput",i.placeholder=t.toString(),i.addEventListener("keyup",e=>{/^@hex/.test(i.value)&&(i.hexMode=!0,i.placeholder="Hex Mode ("+t.toString()+")",i.value=""),/^@qhex/.test(i.value)&&(i.hexMode=0,i.placeholder=t.toString(),i.value="")}),i.addEventListener("dragover",function(e){return e.preventDefault(),e.cancelBubble=!0,!1}),i.addEventListener("drop",function(e){if(e.preventDefault(),e.cancelBubble=!0,e.dataTransfer){let t=e.dataTransfer.files[0],n=new FileReader,a=t.name;if(a.endsWith(".hex")||a.endsWith(".txt"))n.readAsText(t,"utf-8");else{if(!a.endsWith(".bin"))return void showMsg("未知类型 Unknown type");n.readAsArrayBuffer(t)}n.onload=function(e){showMsg("文件已加载 File loaded"),a.endsWith(".hex")||a.endsWith(".txt")?i.attachedHexContent=e.target.result:i.attachedBinaryContent=e.target.result}}return!1}),this.arguments.push(i),e.appendChild(i)}i&&(e.appendChild(i),i.title="Provider ID: "+this.providerID+(this.hasCustomID?", Custom ID: "+this.customID:""),i.id=n),r||(e.style.display="inline-block"),this.container=e}execute(){if(window.android){let e=window.android.getExists();if(e.length){let t=e.split(",");if(t.length%5)return void window.android.update("invalid length")}let t=e.split(","),i=[];for(let e=0;e<t.length;e+=5){let n={id:t[e],name:t[e+1],boardID:t[e+2],nickname:t[e+3],isAdmin:t[e+4]};i.push(n)}let n=i.find(e=>e.id==this.providerID&&e.boardID==this.boardID);if(n){n.name=this.name,e="";for(let t of i)e+=`${e.length?",":""}${t.id},${t.name},${t.boardID},${t.nickname},${t.isAdmin}`}else e+=`${e.length?",":""}${this.providerID},${this.name},${this.boardID},${this.parent.info.nickname},${this.isAdmin?"admin":"user"}`;return void window.android.update(e)}let t=(new Date).getTime(),i=getHash(e.userName+e.password+t.toString(),!0);i=new Uint8Array(i);let n=[];for(let e of this.arguments)if(e.hexMode||e.attachedHexContent||e.attachedBinaryContent){let t=null,i=e.attachedHexContent?e.attachedHexContent.trim():e.value.trim();if(e.attachedBinaryContent)t=new Uint8Array(e.attachedBinaryContent);else{if(/[^0-9a-fA-F ,]/.test(i))return void showMsg("非法字符 Invalid char");if(2===i.length)t=new Uint8Array(1),t[0]=parseInt(i,16);else{let e=/[a-fA-F0-9]{1,2}( |,)[a-fA-F0-9]{1,2}/.test(i);if(e){let e=i.split(/[\s,]/);if(!e.length)return void showMsg("无内容 Empty content");for(let t=0;t<e.length;++t)e[t]=e[t].trim(),e[t].length?e[t]=parseInt(e[t],16):(e.splice(t,1),t>0&&t--);t=new Uint8Array(e)}else{if(i.length%2)return void showMsg("非法长度 Invalid length");let e=[],n="";for(let t=0;t<i.length;t+=2)n=i.substring(t,t+2).trim(),n.length&&e.push(parseInt(n,16));t=new Uint8Array(e)}}}n.push(t)}else{let t=e.value;1===this.parent.serialTail?t+="\r":2===this.parent.serialTail?t+="\n":3===this.parent.serialTail&&(t+="\r\n"),n.push(t)}let a=BigInt("0xC0000000000000BB"),r=[a,this.boardID,e.id,t,i,this.providerID];if(n.length){let t=new Uint8Array(createArrayBuffer(n));this.encrypt&&(t=t.toHex(),t=encrypt(t,e.password,e.password.substring(0,32),!0)),r.push(t)}sendArrayBuffer(r)}}class n{constructor(e){this.buildManagementPanel(),this.updateInfo(e),this.id=this.info.id;let t=create();t.className="device",this.nicknameContainer=this.createNicknameContainer(),t.appendChild(this.nicknameContainer),this.createMoreContainer(),this.buildOTAPanel(),this.buildProviderPanel(),document.body.appendChild(this.moreContainer),t.appendChild(this.providerPanel),this.container=t}isAdmin(){return 32&this.info.extra}createMoreContainer(){let e=create();e.className="deviceMore",e.ondblclick=(e=>{let t=e.target.tagName;"div"==t.toLowerCase()&&(this.moreContainer.className="deviceMore")});let i=create();i.className="serialDataWarper serialDataWarperHide";let n=create("textarea");n.className="serialDataContainer serialDataContainerHide",n.rows="5",this.serialDataContainer=n,this.serialMode=0,this.msgEncoding=0,this.serialTail=0,e.appendChild(t("id: "+this.info.id)),e.appendChild(t("版本: "+this.info.firmwareVersion)),e.appendChild(t("App版本: "+this.info.appVersion));let a=t("串口监视器模式",e=>{this.serialMode=!this.serialMode,this.serialMode?(i.className="serialDataWarper",a.innerText="消息模式"):(i.className="serialDataWarper serialDataWarperHide",a.innerText="串口监视器模式")}),r=t("hex",e=>{2==++this.msgEncoding&&(this.msgEncoding=0),r.innerText=this.msgEncoding?"utf8":"hex"}),s=t("\\r",e=>{0===this.serialTail?(this.serialTail=1,s.innerText="\\n"):1===this.serialTail?(this.serialTail=2,s.innerText="\\r\\n"):2===this.serialTail?(this.serialTail=3,s.innerText="none"):(this.serialTail=0,s.innerText="\\r")}),l=t("clear",e=>{n.value=""});e.appendChild(a),i.appendChild(n),i.appendChild(l),i.appendChild(r),i.appendChild(s),e.appendChild(i),this.moreContainer=e}createNicknameContainer(){let e=create(),i=create("span");return i.innerText=this.info.nickname,e.appendChild(i),this.isAdmin()&&(this.btnMore=t("@",e=>{this.moreContainer.className+=" deviceMoreShow"},null,null,"smallButton"),e.appendChild(this.btnMore)),e}buildManagementPanel(){let e=create();this.managePanel=e}getNetworkFormat(){let e=this.info.extra;return 192==e?"Wifi已连接,AP已开启":128==e?"Wifi已连接,AP已关闭":64==e?"Wifi未连接,AP已开启":void 0}buildProviderPanel(){let e=create(),t=decodeArrayBuffer(this.info.providers.buffer);this.providerPanel=e;let n=create();for(let a=0;a<t.length;a++){let r=decodeArrayBuffer(t[a].buffer,!0,["id","mask","name","customID"]);if(!r)continue;let s=new i(this.id,r.id,r.name,r.mask,this.isAdmin(),void 0!==r.customID?r.customID:null,this);s.container&&(s.showToUser?e.appendChild(s.container):s.lengthOfAArguments?this.moreContainer.appendChild(s.container):n.appendChild(s.container))}this.moreContainer.appendChild(n)}updateInfo(e){this.info={cpu:e[2],extra:e[3],time:e[4],heap:e[5],nickname:e[6],id:e[7],firmwareVersion:e[8],appVersion:e[9],providers:e[10]}}buildOTAPanel(){let e=create();this.firmware=null;let i=t("加载固件",e=>{let t=create("input");t.type="file";let i=new FileReader;t.onchange=(e=>{let n=t.files[0];i.readAsArrayBuffer(n),i.onload=(e=>{this.firmware=i.result,this.showMsg("固件已加载, 大小: "+this.firmware.byteLength+"字节",1e5)})}),t.click()}),n=t("更新固件",e=>{this.ota(!0)});e.appendChild(i),e.appendChild(n),this.moreContainer.appendChild(e)}ota(){if(!this.firmware)return void showMsg("尚未加载固件");showMsg("正在上传固件");let t=(new Date).getTime(),i=getHash(e.userName+e.password+t.toString(),!0);i=new Uint8Array(i);let n=new Uint8Array(this.firmware),a=new Uint8Array(getHash(n,!0));sendArrayBuffer([171,this.id,e.id,n,t,i,parseInt(8192),a])}otaProgress(e){this.showMsg("升级固件: "+e+"%")}commandResponse(e){showMsg(e)}showMsg(e,t){if("u8a"==getType(e)){let t=decodeArrayBuffer(e.buffer);e=t.length?t[0]:this.msgEncoding?e.toHex():(new TextDecoder).decode(e)}"b"==getType(e)&&(e=Number(e)),"number"==getType(e)&&(e=e.toString()),this.serialMode?this.serialDataContainer.value+=e:(this.tShowMsg&&clearTimeout(this.tShowMsg),this.nicknameContainer.children[0].innerText=e,this.tShowMsg=setTimeout(()=>{this.nicknameContainer.children[0].innerText=this.info.nickname},t||1e4))}}e.Device=n})();