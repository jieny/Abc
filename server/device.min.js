(function(){let e=window,t=(e,t,i,n,s)=>{let r=create("a");return r.className=s||"button",r.innerText=e,r.onclick=t,r.ondblclick=i,n&&(r.id=n),r};class i{constructor(e,t,i,n,s,r){this.boardID=e,this.providerID=t,null!==r&&(this.customID=r,this.hasCustomID=!0),this.name=i,this.mask=n,this.isAdmin=s,this.arguments=[],this.showToUser=!1,this.buildContainer()}buildContainer(){let e=create(),i=null,n=getHash(this.boardID+this.providerID+this.name);e.id=n+"_container";let s=this.mask,r=7&s;this.lengthOfAArguments=r;let a=128&s,o=64&s,h=32&s,l=8&s;this.encrypt=!!l,a||o||h?this.isAdmin?a?i=t(this.name,e=>{this.execute()}):o&&(i=t(this.name,0,e=>{this.execute()})):e.style.display="none":(e.style.display="inline-block",i=t(this.name,e=>{this.execute()}),this.showToUser=!0);for(let t=0;t<r;++t){let i=create("input");i.type="text",i.className="LoginInput",i.placeholder=t.toString(),this.arguments.push(i),e.appendChild(i)}i&&(e.appendChild(i),i.title="Provider ID: "+this.providerID+(this.hasCustomID?", Custom ID: "+this.customID:""),i.id=n),r||(e.style.display="inline-block"),this.container=e}execute(){let t=(new Date).getTime(),i=getHash(e.userName+e.password+t.toString(),!0);i=new Uint8Array(i);let n=[];for(let e of this.arguments)n.push(e.value);let s=BigInt("0xC0000000000000BB"),r=[s,this.boardID,e.id,t,i,this.providerID];if(n.length){let t=new Uint8Array(createArrayBuffer(n));this.encrypt&&(t=t.toHex(),t=encrypt(t,e.password,e.password.substring(0,32),!0)),r.push(t)}sendArrayBuffer(r)}}class n{constructor(e){this.buildManagementPanel(),this.updateInfo(e),this.id=this.info.id;let t=create();t.className="device",this.nicknameContainer=this.createNicknameContainer(),t.appendChild(this.nicknameContainer),this.createMoreContainer(),this.buildOTAPanel(),this.buildProviderPanel(),document.body.appendChild(this.moreContainer),t.appendChild(this.providerPanel),this.container=t}isAdmin(){return 32&this.info.extra}createMoreContainer(){let e=create();e.className="deviceMore",e.onclick=(e=>{if(e.path&&e.path.length){let t=e.path[0].tagName||e.path[0].nodeName;"div"==t.toLowerCase()&&(this.moreContainer.className="deviceMore")}}),e.appendChild(t("id: "+this.info.id)),e.appendChild(t("版本: "+this.info.firmwareVersion)),e.appendChild(t("App版本: "+this.info.appVersion)),this.moreContainer=e}createNicknameContainer(){let e=create(),i=create("span");return i.innerText=this.info.nickname,e.appendChild(i),this.isAdmin()&&(this.btnMore=t("@",e=>{this.moreContainer.className+=" deviceMoreShow"},null,null,"smallButton"),e.appendChild(this.btnMore)),e}buildManagementPanel(){let e=create();this.managePanel=e}getNetworkFormat(){let e=this.info.extra;return 192==e?"Wifi已连接,AP已开启":128==e?"Wifi已连接,AP已关闭":64==e?"Wifi未连接,AP已开启":void 0}buildProviderPanel(){let e=create(),t=decodeArrayBuffer(this.info.providers.buffer);this.providerPanel=e;let n=create();for(let s=0;s<t.length;s++){let r=decodeArrayBuffer(t[s].buffer,!0,["id","mask","name","customID"]);if(!r)continue;let a=new i(this.id,r.id,r.name,r.mask,this.isAdmin(),void 0!==r.customID?r.customID:null);a.container&&(a.showToUser?e.appendChild(a.container):a.lengthOfAArguments?this.moreContainer.appendChild(a.container):n.appendChild(a.container))}this.moreContainer.appendChild(n)}updateInfo(e){this.info={cpu:e[2],extra:e[3],time:e[4],heap:e[5],nickname:e[6],id:e[7],firmwareVersion:e[8],appVersion:e[9],providers:e[10]}}buildOTAPanel(){let e=create();this.firmware=null;let i=t("加载固件",e=>{let t=create("input");t.type="file";let i=new FileReader;t.onchange=(e=>{let n=t.files[0];i.readAsArrayBuffer(n),i.onload=(e=>{this.firmware=i.result,this.showMsg("固件已加载, 大小: "+this.firmware.byteLength+"字节",1e5)})}),t.click()}),n=t("更新固件",e=>{this.ota(!0)});e.appendChild(i),e.appendChild(n),this.moreContainer.appendChild(e)}ota(){if(!this.firmware)return void showMsg("尚未加载固件");showMsg("正在上传固件");let t=(new Date).getTime(),i=getHash(e.userName+e.password+t.toString(),!0);i=new Uint8Array(i);let n=new Uint8Array(this.firmware),s=new Uint8Array(getHash(n,!0));sendArrayBuffer([171,this.id,e.id,n,t,i,parseInt(8192),s])}otaProgress(e){this.showMsg("升级固件: "+e+"%")}commandResponse(e){showMsg(e)}showMsg(e,t){"b"==getType(e)&&(e=Number(e)),"number"==getType(e)&&(e=e.toString()),this.tShowMsg&&clearTimeout(this.tShowMsg),this.nicknameContainer.children[0].innerText=e,this.tShowMsg=setTimeout(()=>{this.nicknameContainer.children[0].innerText=this.info.nickname},t||1e4)}}e.Device=n})();