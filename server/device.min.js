(function(){let e=window,t=(e,t,i,n,r)=>{let a=create("a");return a.className=r||"button",a.innerText=e,a.onclick=t,a.ondblclick=i,n&&(a.id=n),a};class i{constructor(e,t,i,n,r,a){this.boardID=e,this.providerID=t,null!==a&&(this.customID=a,this.hasCustomID=!0),this.name=i,this.mask=n,this.isAdmin=r,this.arguments=[],this.showToUser=!1,this.buildContainer()}buildContainer(){let e=create(),i=null,n=getHash(this.boardID+this.providerID+this.name);e.id=n+"_container";let r=this.mask,a=7&r;this.lengthOfAArguments=a;let s=128&r,o=64&r,h=32&r,l=8&r;this.encrypt=!!l,s||o||h?this.isAdmin?s?i=t(this.name,e=>{this.execute()}):o&&(i=t(this.name,0,e=>{this.execute()})):e.style.display="none":(e.style.display="inline-block",i=t(this.name,e=>{this.execute()}),this.showToUser=!0);for(let t=0;t<a;++t){let i=create("input");i.type="text",i.className="LoginInput",i.placeholder=t.toString(),i.addEventListener("keyup",e=>{/^@hex/.test(i.value)&&(i.hexMode=!0,i.placeholder="Hex Mode ("+t.toString()+")",i.value=""),/^@qhex/.test(i.value)&&(i.hexMode=0,i.placeholder=t.toString(),i.value="")}),i.addEventListener("dragover",function(e){return e.preventDefault(),e.cancelBubble=!0,!1}),i.addEventListener("drop",function(e){if(e.preventDefault(),e.cancelBubble=!0,e.dataTransfer){let t=e.dataTransfer.files[0],n=new FileReader,r=t.name;if(r.endsWith(".hex")||r.endsWith(".txt"))n.readAsText(t,"utf-8");else{if(!r.endsWith(".bin"))return void showMsg("未知类型 Unknown type");n.readAsArrayBuffer(t)}n.onload=function(e){showMsg("文件已加载 File loaded"),r.endsWith(".hex")||r.endsWith(".txt")?i.attachedHexContent=e.target.result:i.attachedBinaryContent=e.target.result}}return!1}),this.arguments.push(i),e.appendChild(i)}i&&(e.appendChild(i),i.title="Provider ID: "+this.providerID+(this.hasCustomID?", Custom ID: "+this.customID:""),i.id=n),a||(e.style.display="inline-block"),this.container=e}execute(){let t=(new Date).getTime(),i=getHash(e.userName+e.password+t.toString(),!0);i=new Uint8Array(i);let n=[];for(let e of this.arguments)if(e.hexMode||e.attachedHexContent||e.attachedBinaryContent){let t=null,i=e.attachedHexContent?e.attachedHexContent.trim():e.value.trim();if(e.attachedBinaryContent)t=new Uint8Array(e.attachedBinaryContent);else{if(/[^0-9a-fA-F ,]/.test(i))return void showMsg("非法字符 Invalid char");if(2===i.length)t=new Uint8Array(1),t[0]=parseInt(i,16);else{let e=/[a-fA-F0-9]{1,2}( |,)[a-fA-F0-9]{1,2}/.test(i);if(e){let e=i.split(/[\s,]/);if(!e.length)return void showMsg("无内容 Empty content");for(let t=0;t<e.length;++t)e[t]=e[t].trim(),e[t].length?e[t]=parseInt(e[t],16):(e.splice(t,1),t>0&&t--);t=new Uint8Array(e)}else{if(i.length%2)return void showMsg("非法长度 Invalid length");let e=[],n="";for(let t=0;t<i.length;t+=2)n=i.substring(t,t+2).trim(),n.length&&e.push(parseInt(n,16));t=new Uint8Array(e)}}}n.push(t)}else n.push(e.value);let r=BigInt("0xC0000000000000BB"),a=[r,this.boardID,e.id,t,i,this.providerID];if(n.length){let t=new Uint8Array(createArrayBuffer(n));this.encrypt&&(t=t.toHex(),t=encrypt(t,e.password,e.password.substring(0,32),!0)),a.push(t)}sendArrayBuffer(a)}}class n{constructor(e){this.buildManagementPanel(),this.updateInfo(e),this.id=this.info.id;let t=create();t.className="device",this.nicknameContainer=this.createNicknameContainer(),t.appendChild(this.nicknameContainer),this.createMoreContainer(),this.buildOTAPanel(),this.buildProviderPanel(),document.body.appendChild(this.moreContainer),t.appendChild(this.providerPanel),this.container=t}isAdmin(){return 32&this.info.extra}createMoreContainer(){let e=create();e.className="deviceMore",e.ondblclick=(e=>{let t=e.target.tagName;"div"==t.toLowerCase()&&(this.moreContainer.className="deviceMore")}),e.appendChild(t("id: "+this.info.id)),e.appendChild(t("版本: "+this.info.firmwareVersion)),e.appendChild(t("App版本: "+this.info.appVersion)),this.moreContainer=e}createNicknameContainer(){let e=create(),i=create("span");return i.innerText=this.info.nickname,e.appendChild(i),this.isAdmin()&&(this.btnMore=t("@",e=>{this.moreContainer.className+=" deviceMoreShow"},null,null,"smallButton"),e.appendChild(this.btnMore)),e}buildManagementPanel(){let e=create();this.managePanel=e}getNetworkFormat(){let e=this.info.extra;return 192==e?"Wifi已连接,AP已开启":128==e?"Wifi已连接,AP已关闭":64==e?"Wifi未连接,AP已开启":void 0}buildProviderPanel(){let e=create(),t=decodeArrayBuffer(this.info.providers.buffer);this.providerPanel=e;let n=create();for(let r=0;r<t.length;r++){let a=decodeArrayBuffer(t[r].buffer,!0,["id","mask","name","customID"]);if(!a)continue;let s=new i(this.id,a.id,a.name,a.mask,this.isAdmin(),void 0!==a.customID?a.customID:null);s.container&&(s.showToUser?e.appendChild(s.container):s.lengthOfAArguments?this.moreContainer.appendChild(s.container):n.appendChild(s.container))}this.moreContainer.appendChild(n)}updateInfo(e){this.info={cpu:e[2],extra:e[3],time:e[4],heap:e[5],nickname:e[6],id:e[7],firmwareVersion:e[8],appVersion:e[9],providers:e[10]}}buildOTAPanel(){let e=create();this.firmware=null;let i=t("加载固件",e=>{let t=create("input");t.type="file";let i=new FileReader;t.onchange=(e=>{let n=t.files[0];i.readAsArrayBuffer(n),i.onload=(e=>{this.firmware=i.result,this.showMsg("固件已加载, 大小: "+this.firmware.byteLength+"字节",1e5)})}),t.click()}),n=t("更新固件",e=>{this.ota(!0)});e.appendChild(i),e.appendChild(n),this.moreContainer.appendChild(e)}ota(){if(!this.firmware)return void showMsg("尚未加载固件");showMsg("正在上传固件");let t=(new Date).getTime(),i=getHash(e.userName+e.password+t.toString(),!0);i=new Uint8Array(i);let n=new Uint8Array(this.firmware),r=new Uint8Array(getHash(n,!0));sendArrayBuffer([171,this.id,e.id,n,t,i,parseInt(8192),r])}otaProgress(e){this.showMsg("升级固件: "+e+"%")}commandResponse(e){showMsg(e)}showMsg(e,t){"b"==getType(e)&&(e=Number(e)),"number"==getType(e)&&(e=e.toString()),this.tShowMsg&&clearTimeout(this.tShowMsg),this.nicknameContainer.children[0].innerText=e,this.tShowMsg=setTimeout(()=>{this.nicknameContainer.children[0].innerText=this.info.nickname},t||1e4)}}e.Device=n})();